name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://vision.nexaratech.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy New Stack to Production
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
        run: |
          ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} << 'ENDSSH'
            set -e

            echo "=========================================="
            echo "Deploying NEW Stack to PRODUCTION"
            echo "Next.js + NestJS + Python ML Service"
            echo "=========================================="

            # Create production directory
            DEPLOY_DIR=~/nexara-vision-production
            mkdir -p $DEPLOY_DIR
            cd $DEPLOY_DIR

            # Clone or pull latest code from main branch
            if [ -d ".git" ]; then
              echo "ðŸ“¥ Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            else
              echo "ðŸ“¥ Cloning repository..."
              git clone -b main https://github.com/Rizeqalhaj/NexeraVision.git .
            fi

            echo ""
            echo "=========================================="
            echo "STEP 1: Deploy Next.js Frontend"
            echo "=========================================="

            # Stop old Docker container if exists (migration cleanup)
            echo "ðŸ›‘ Stopping old Docker container services..."
            docker stop violence-detection 2>/dev/null || true
            docker rm violence-detection 2>/dev/null || true

            cd $DEPLOY_DIR/web_app_nextjs

            # Install dependencies
            echo "ðŸ“¦ Installing frontend dependencies..."
            npm ci

            # Build Next.js app
            echo "ðŸ”¨ Building Next.js app..."
            npm run build

            # Remove devDependencies after build to save space
            npm prune --production

            # Stop existing frontend PM2 process
            pm2 delete nexara-vision-frontend-production 2>/dev/null || true

            # Start frontend on port 3005
            echo "ðŸš€ Starting Next.js frontend on port 3005..."
            PORT=3005 pm2 start npm --name "nexara-vision-frontend-production" -- start

            echo ""
            echo "=========================================="
            echo "STEP 2: Deploy NestJS Backend"
            echo "=========================================="

            cd $DEPLOY_DIR/web_app_backend

            # Install dependencies
            echo "ðŸ“¦ Installing backend dependencies..."
            npm ci

            # Create .env file
            echo "âš™ï¸  Creating environment configuration..."
            printf '%s\n' \
              'PORT=3006' \
              'NODE_ENV=production' \
              'DATABASE_URL=postgresql://postgres:E$$athecode006@localhost:5433/nexara_vision_production' \
              'ML_SERVICE_URL=http://localhost:3007' \
              'JWT_SECRET=nexara-vision-production-secret-key-2024' \
              'REDIS_HOST=localhost' \
              'REDIS_PORT=6379' \
              'CORS_ORIGIN=https://vision.nexaratech.io,http://localhost:3006' \
              > .env

            # Run Prisma migrations
            echo "ðŸ—„ï¸  Running database migrations..."
            set -a && source .env && set +a
            npx prisma generate
            npx prisma migrate deploy 2>/dev/null || echo "âš ï¸  Migration skipped (may not be needed)"

            # Build NestJS app
            echo "ðŸ”¨ Building NestJS backend..."
            npm run build

            # Stop existing backend PM2 process
            pm2 delete nexara-vision-backend-production 2>/dev/null || true

            # Start backend on port 3006
            echo "ðŸš€ Starting NestJS backend on port 3006..."
            PORT=3006 pm2 start dist/src/main.js --name "nexara-vision-backend-production"

            echo ""
            echo "=========================================="
            echo "STEP 3: Deploy Python ML Service"
            echo "=========================================="

            if [ -d "$DEPLOY_DIR/ml_service" ]; then
              cd $DEPLOY_DIR/ml_service

              # Stop existing ML service container
              echo "ðŸ›‘ Stopping existing ML service..."
              docker stop nexara-ml-service-production 2>/dev/null || true
              docker rm nexara-ml-service-production 2>/dev/null || true

              # Build Docker image
              echo "ðŸ”¨ Building ML service Docker image..."
              if docker build -t nexara-ml-service:production . 2>&1 | tail -20; then
                # Run ML service container on port 3007
                echo "ðŸš€ Starting ML service on port 3007..."
                docker run -d \
                  --name nexara-ml-service-production \
                  -p 3007:8000 \
                  --restart unless-stopped \
                  -v $DEPLOY_DIR/models:/app/models:ro \
                  nexara-ml-service:production || echo "âš ï¸  ML service failed to start"
              else
                echo "âš ï¸  ML service build failed (skipping)"
              fi
            else
              echo "âš ï¸  ML service directory not found (skipping)"
            fi

            echo ""
            echo "=========================================="
            echo "STEP 4: Configure Nginx"
            echo "=========================================="

            # Create nginx config for production stack
            echo "âš™ï¸  Configuring nginx for production..."
            printf '%s\n' \
              'server {' \
              '    listen 80;' \
              '    listen 443 ssl http2;' \
              '    server_name vision.nexaratech.io;' \
              '' \
              '    ssl_certificate /etc/letsencrypt/live/vision.nexaratech.io/fullchain.pem;' \
              '    ssl_certificate_key /etc/letsencrypt/live/vision.nexaratech.io/privkey.pem;' \
              '' \
              '    client_max_body_size 100M;' \
              '' \
              '    # Next.js Frontend' \
              '    location / {' \
              '        proxy_pass http://localhost:3005;' \
              '        proxy_http_version 1.1;' \
              '        proxy_set_header Upgrade $http_upgrade;' \
              '        proxy_set_header Connection "upgrade";' \
              '        proxy_set_header Host $host;' \
              '        proxy_cache_bypass $http_upgrade;' \
              '        proxy_set_header X-Real-IP $remote_addr;' \
              '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
              '        proxy_set_header X-Forwarded-Proto $scheme;' \
              '    }' \
              '' \
              '    # NestJS Backend API' \
              '    location /api {' \
              '        proxy_pass http://localhost:3006;' \
              '        proxy_http_version 1.1;' \
              '        proxy_set_header Upgrade $http_upgrade;' \
              '        proxy_set_header Connection "upgrade";' \
              '        proxy_set_header Host $host;' \
              '        proxy_cache_bypass $http_upgrade;' \
              '        proxy_set_header X-Real-IP $remote_addr;' \
              '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
              '        proxy_set_header X-Forwarded-Proto $scheme;' \
              '        proxy_connect_timeout 600;' \
              '        proxy_send_timeout 600;' \
              '        proxy_read_timeout 600;' \
              '        send_timeout 600;' \
              '    }' \
              '' \
              '    # ML Service (internal - not exposed publicly)' \
              '    # Accessible only via backend at http://localhost:3007' \
              '}' \
              | sudo tee /etc/nginx/sites-available/violence-detection > /dev/null

            sudo ln -sf /etc/nginx/sites-available/violence-detection /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx

            echo ""
            echo "=========================================="
            echo "STEP 5: Health Checks"
            echo "=========================================="

            # Wait for services to start
            sleep 5

            # Check PM2 processes
            echo "ðŸ“Š PM2 Process Status:"
            pm2 list | grep production

            # Check Docker containers
            echo ""
            echo "ðŸ³ Docker Container Status:"
            docker ps | grep production || echo "âš ï¸  No production ML container running"

            # Test endpoints with retry
            echo ""
            echo "ðŸ” Testing Endpoints (with retry):"

            # Test frontend with retry
            echo -n "Testing Frontend (Next.js) on port 3005... "
            for i in {1..10}; do
              if curl -f http://localhost:3005 > /dev/null 2>&1; then
                echo "âœ“ OK"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "âœ— FAILED after 10 retries"
                exit 1
              else
                sleep 2
              fi
            done

            # Test backend with retry
            echo -n "Testing Backend (NestJS) on port 3006... "
            for i in {1..10}; do
              if curl -f http://localhost:3006/api > /dev/null 2>&1; then
                echo "âœ“ OK"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "âœ— FAILED after 10 retries (critical)"
                exit 1
              else
                sleep 2
              fi
            done

            # Test ML service (optional but recommended)
            if docker ps | grep -q nexara-ml-service-production; then
              echo -n "Testing ML Service (Python) on port 3007... "
              for i in {1..5}; do
                if curl -f http://localhost:3007/health > /dev/null 2>&1; then
                  echo "âœ“ OK"
                  break
                fi
                if [ $i -eq 5 ]; then
                  echo "âš ï¸  FAILED (non-critical)"
                else
                  sleep 2
                fi
              done
            fi

            echo ""
            echo "=========================================="
            echo "âœ“ Production Deployment Complete!"
            echo "=========================================="
            echo "ðŸŒ Production URL: https://vision.nexaratech.io"
            echo ""
            echo "Services:"
            echo "  â€¢ Frontend (Next.js): port 3005"
            echo "  â€¢ Backend (NestJS): port 3006"
            echo "  â€¢ ML Service (Python): port 3007"
            echo ""
            echo "PM2 Processes:"
            echo "  â€¢ nexara-vision-frontend-production"
            echo "  â€¢ nexara-vision-backend-production"
            echo ""
            echo "Docker Containers:"
            echo "  â€¢ nexara-ml-service-production"
            echo "=========================================="

            # Save PM2 process list
            pm2 save

            # Clean up old Docker images (keep last 3)
            echo "Cleaning up old Docker images..."
            docker image prune -f 2>/dev/null || true
          ENDSSH

      - name: Notify Success
        if: success()
        run: |
          echo "âœ“ Successfully deployed NEW stack to production!"
          echo "Production URL: https://vision.nexaratech.io"
          echo ""
          echo "Stack deployed:"
          echo "  â€¢ Next.js Frontend (port 3005)"
          echo "  â€¢ NestJS Backend (port 3006)"
          echo "  â€¢ Python ML Service (port 3007)"

      - name: Notify Failure
        if: failure()
        run: |
          echo "âœ— Production deployment failed"
          echo "Check the logs above for details"
          exit 1
