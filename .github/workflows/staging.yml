name: Deploy to Staging

on:
  push:
    branches:
      - development
  workflow_dispatch:  # Manual trigger enabled

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy New Stack to Staging
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SSH_USER: ${{ secrets.SSH_USER }}
          STAGING_DOMAIN: ${{ secrets.STAGING_DOMAIN }}
        run: |
          ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} << 'ENDSSH'
            set -e

            echo "=========================================="
            echo "Deploying NEW Stack to STAGING"
            echo "Next.js + NestJS + Python ML Service"
            echo "=========================================="

            # Create staging directory
            DEPLOY_DIR=~/nexara-vision-staging
            mkdir -p $DEPLOY_DIR
            cd $DEPLOY_DIR

            # Clone or pull latest code from development branch
            if [ -d ".git" ]; then
              echo "üì• Updating existing repository..."
              git fetch origin
              git reset --hard origin/development
              git clean -fd
            else
              echo "üì• Cloning repository..."
              git clone -b development https://github.com/Rizeqalhaj/NexeraVision.git .
            fi

            echo ""
            echo "=========================================="
            echo "STEP 1: Deploy Next.js Frontend"
            echo "=========================================="

            # Stop old Docker container using port 8001 if exists
            echo "üõë Stopping old services on port 8001..."
            docker stop violence-detection-staging 2>/dev/null || true
            docker rm violence-detection-staging 2>/dev/null || true

            cd $DEPLOY_DIR/web_app_nextjs

            # Install dependencies
            echo "üì¶ Installing frontend dependencies..."
            npm ci

            # Build Next.js app
            echo "üî® Building Next.js app..."
            npm run build

            # Remove devDependencies after build to save space
            npm prune --production

            # Stop existing frontend PM2 process
            pm2 delete nexara-vision-frontend-staging 2>/dev/null || true

            # Start frontend on port 8001
            echo "üöÄ Starting Next.js frontend on port 8001..."
            PORT=8001 pm2 start npm --name "nexara-vision-frontend-staging" -- start

            echo ""
            echo "=========================================="
            echo "STEP 2: Deploy NestJS Backend"
            echo "=========================================="

            cd $DEPLOY_DIR/web_app_backend

            # Install dependencies
            echo "üì¶ Installing backend dependencies..."
            npm ci

            # Create .env file
            echo "‚öôÔ∏è  Creating environment configuration..."
            printf '%s\n' \
              'PORT=8002' \
              'NODE_ENV=production' \
              'DATABASE_URL=postgresql://postgres:E$$athecode006@localhost:5433/nexara_vision_staging' \
              'ML_SERVICE_URL=http://localhost:8003' \
              'JWT_SECRET=nexara-vision-staging-secret-key-2024' \
              'REDIS_HOST=localhost' \
              'REDIS_PORT=6379' \
              'CORS_ORIGIN=http://stagingvision.nexaratech.io,http://localhost:8002' \
              > .env

            # Run Prisma migrations
            echo "üóÑÔ∏è  Running database migrations..."
            set -a && source .env && set +a
            npx prisma generate
            npx prisma migrate deploy 2>/dev/null || echo "‚ö†Ô∏è  Migration skipped (may not be needed)"

            # Build NestJS app
            echo "üî® Building NestJS backend..."
            npm run build

            # Stop existing backend PM2 process
            pm2 delete nexara-vision-backend-staging 2>/dev/null || true

            # Start backend on port 8002
            echo "üöÄ Starting NestJS backend on port 8002..."
            PORT=8002 pm2 start dist/src/main.js --name "nexara-vision-backend-staging"

            echo ""
            echo "=========================================="
            echo "STEP 3: Deploy Python ML Service (Optional)"
            echo "=========================================="

            # ML service deployment is optional - don't fail if it doesn't work
            if [ -d "$DEPLOY_DIR/ml_service" ]; then
              cd $DEPLOY_DIR/ml_service

              # Stop existing ML service container
              echo "üõë Stopping existing ML service..."
              docker stop nexara-ml-service-staging 2>/dev/null || true
              docker rm nexara-ml-service-staging 2>/dev/null || true

              # Build Docker image (skip if fails)
              echo "üî® Building ML service Docker image..."
              if docker build -t nexara-ml-service:staging . 2>&1 | tail -20; then
                # Run ML service container on port 8003
                echo "üöÄ Starting ML service on port 8003..."
                docker run -d \
                  --name nexara-ml-service-staging \
                  -p 8003:8000 \
                  --restart unless-stopped \
                  -v $DEPLOY_DIR/models:/app/models:ro \
                  nexara-ml-service:staging || echo "‚ö†Ô∏è  ML service failed to start (non-critical)"
              else
                echo "‚ö†Ô∏è  ML service build failed (skipping - non-critical)"
              fi
            else
              echo "‚ö†Ô∏è  ML service directory not found (skipping)"
            fi

            echo ""
            echo "=========================================="
            echo "STEP 4: Configure Nginx"
            echo "=========================================="

            # Create nginx config for new stack
            echo "‚öôÔ∏è  Configuring nginx..."
            printf '%s\n' \
              'server {' \
              '    listen 80;' \
              '    server_name stagingvision.nexaratech.io;' \
              '    client_max_body_size 100M;' \
              '' \
              '    # Next.js Frontend' \
              '    location / {' \
              '        proxy_pass http://localhost:8001;' \
              '        proxy_http_version 1.1;' \
              '        proxy_set_header Upgrade $http_upgrade;' \
              '        proxy_set_header Connection "upgrade";' \
              '        proxy_set_header Host $host;' \
              '        proxy_cache_bypass $http_upgrade;' \
              '        proxy_set_header X-Real-IP $remote_addr;' \
              '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
              '        proxy_set_header X-Forwarded-Proto $scheme;' \
              '    }' \
              '' \
              '    # NestJS Backend API' \
              '    location /api {' \
              '        proxy_pass http://localhost:8002;' \
              '        proxy_http_version 1.1;' \
              '        proxy_set_header Upgrade $http_upgrade;' \
              '        proxy_set_header Connection "upgrade";' \
              '        proxy_set_header Host $host;' \
              '        proxy_cache_bypass $http_upgrade;' \
              '        proxy_set_header X-Real-IP $remote_addr;' \
              '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
              '        proxy_set_header X-Forwarded-Proto $scheme;' \
              '        proxy_connect_timeout 600;' \
              '        proxy_send_timeout 600;' \
              '        proxy_read_timeout 600;' \
              '        send_timeout 600;' \
              '    }' \
              '' \
              '    # ML Service (internal - not exposed publicly)' \
              '    # Accessible only via backend at http://localhost:8003' \
              '}' \
              | sudo tee /etc/nginx/sites-available/violence-detection-staging > /dev/null

            sudo ln -sf /etc/nginx/sites-available/violence-detection-staging /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx

            echo ""
            echo "=========================================="
            echo "STEP 5: Health Checks"
            echo "=========================================="

            # Wait for services to start
            sleep 5

            # Check PM2 processes
            echo "üìä PM2 Process Status:"
            pm2 list | grep staging

            # Check Docker containers
            echo ""
            echo "üê≥ Docker Container Status:"
            docker ps | grep staging || echo "‚ö†Ô∏è  No staging containers running (ML service is optional)"

            # Test endpoints with retry
            echo ""
            echo "üîç Testing Endpoints (with retry):"

            # Test frontend with retry
            echo -n "Testing Frontend (Next.js) on port 8001... "
            for i in {1..10}; do
              if curl -f http://localhost:8001 > /dev/null 2>&1; then
                echo "‚úì OK"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "‚úó FAILED after 10 retries"
              else
                sleep 2
              fi
            done

            # Test backend with retry
            echo -n "Testing Backend (NestJS) on port 8002... "
            for i in {1..10}; do
              if curl -f http://localhost:8002 > /dev/null 2>&1; then
                echo "‚úì OK"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "‚ö†Ô∏è  FAILED (may need Redis configuration)"
              else
                sleep 2
              fi
            done

            # Test ML service (optional)
            if docker ps | grep -q nexara-ml-service-staging; then
              echo -n "Testing ML Service (Python) on port 8003... "
              for i in {1..5}; do
                if curl -f http://localhost:8003/health > /dev/null 2>&1; then
                  echo "‚úì OK"
                  break
                fi
                if [ $i -eq 5 ]; then
                  echo "‚ö†Ô∏è  FAILED (non-critical)"
                else
                  sleep 2
                fi
              done
            fi

            echo ""
            echo "=========================================="
            echo "‚úì Staging Deployment Complete!"
            echo "=========================================="
            echo "üåê Staging URL: http://stagingvision.nexaratech.io"
            echo ""
            echo "Services:"
            echo "  ‚Ä¢ Frontend (Next.js): port 8001"
            echo "  ‚Ä¢ Backend (NestJS): port 8002"
            echo "  ‚Ä¢ ML Service (Python): port 8003"
            echo ""
            echo "PM2 Processes:"
            echo "  ‚Ä¢ nexara-vision-frontend-staging"
            echo "  ‚Ä¢ nexara-vision-backend-staging"
            echo ""
            echo "Docker Containers:"
            echo "  ‚Ä¢ nexara-ml-service-staging"
            echo "=========================================="

            # Save PM2 process list
            pm2 save
          ENDSSH

      - name: Notify Success
        if: success()
        run: |
          echo "‚úì Successfully deployed NEW stack to staging!"
          echo "Staging URL: http://stagingvision.nexaratech.io"
          echo ""
          echo "Stack deployed:"
          echo "  ‚Ä¢ Next.js Frontend"
          echo "  ‚Ä¢ NestJS Backend"
          echo "  ‚Ä¢ Python ML Service"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚úó Staging deployment failed"
          echo "Check the logs above for details"
          exit 1
