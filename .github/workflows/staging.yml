name: Deploy to Staging

on:
  push:
    branches:
      - development
  workflow_dispatch:

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy New Stack to Staging
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SSH_USER: ${{ secrets.SSH_USER }}
          STAGING_DOMAIN: ${{ secrets.STAGING_DOMAIN }}
        run: |
          ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} << 'ENDSSH'
            set -e

            echo "=========================================="
            echo "Deploying NEW Stack to STAGING"
            echo "Next.js + NestJS + Python ML Service"
            echo "=========================================="

            # Create staging directory
            DEPLOY_DIR=~/nexara-vision-staging
            mkdir -p $DEPLOY_DIR
            cd $DEPLOY_DIR

            # Clone or pull latest code from development branch
            if [ -d ".git" ]; then
              echo "üì• Updating existing repository..."
              git fetch origin
              git reset --hard origin/development
              git clean -fd
            else
              echo "üì• Cloning repository..."
              git clone -b development https://github.com/Rizeqalhaj/NexeraVision.git .
            fi

            echo ""
            echo "=========================================="
            echo "STEP 1: Deploy Next.js Frontend"
            echo "=========================================="

            cd $DEPLOY_DIR/web_app_nextjs

            # Install dependencies
            echo "üì¶ Installing frontend dependencies..."
            npm ci --production

            # Build Next.js app
            echo "üî® Building Next.js app..."
            npm run build

            # Stop existing frontend PM2 process
            pm2 delete nexara-vision-frontend-staging 2>/dev/null || true

            # Start frontend on port 3001
            echo "üöÄ Starting Next.js frontend on port 3001..."
            PORT=3001 pm2 start npm --name "nexara-vision-frontend-staging" -- start

            echo ""
            echo "=========================================="
            echo "STEP 2: Deploy NestJS Backend"
            echo "=========================================="

            cd $DEPLOY_DIR/web_app_backend

            # Install dependencies
            echo "üì¶ Installing backend dependencies..."
            npm ci --production

            # Create .env file
            echo "‚öôÔ∏è  Creating environment configuration..."
            cat > .env << 'ENVEOF'
PORT=3002
NODE_ENV=production
DATABASE_URL=postgresql://postgres:E\$\$athecode006@localhost:5432/nexara_vision_staging
ML_SERVICE_URL=http://localhost:8003
JWT_SECRET=nexara-vision-staging-secret-key-2024
ENVEOF

            # Run Prisma migrations
            echo "üóÑÔ∏è  Running database migrations..."
            npx prisma generate
            npx prisma migrate deploy 2>/dev/null || echo "‚ö†Ô∏è  Migration skipped (may not be needed)"

            # Build NestJS app
            echo "üî® Building NestJS backend..."
            npm run build

            # Stop existing backend PM2 process
            pm2 delete nexara-vision-backend-staging 2>/dev/null || true

            # Start backend on port 3002
            echo "üöÄ Starting NestJS backend on port 3002..."
            PORT=3002 pm2 start dist/main.js --name "nexara-vision-backend-staging"

            echo ""
            echo "=========================================="
            echo "STEP 3: Deploy Python ML Service"
            echo "=========================================="

            cd $DEPLOY_DIR/ml_service

            # Stop existing ML service container
            echo "üõë Stopping existing ML service..."
            docker stop nexara-ml-service-staging 2>/dev/null || true
            docker rm nexara-ml-service-staging 2>/dev/null || true

            # Build Docker image
            echo "üî® Building ML service Docker image..."
            docker build -t nexara-ml-service:staging .

            # Run ML service container on port 8003
            echo "üöÄ Starting ML service on port 8003..."
            docker run -d \
              --name nexara-ml-service-staging \
              -p 8003:8000 \
              --restart unless-stopped \
              -v $DEPLOY_DIR/models:/app/models:ro \
              nexara-ml-service:staging

            echo ""
            echo "=========================================="
            echo "STEP 4: Configure Nginx"
            echo "=========================================="

            # Create nginx config for new stack
            echo "‚öôÔ∏è  Configuring nginx..."
            sudo tee /etc/nginx/sites-available/violence-detection-staging > /dev/null << 'NGINXEOF'
server {
    listen 80;
    server_name stagingvision.nexaratech.io;
    client_max_body_size 100M;

    # Next.js Frontend
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # NestJS Backend API
    location /api {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        send_timeout 600;
    }

    # ML Service (internal - not exposed publicly)
    # Accessible only via backend at http://localhost:8003
}
NGINXEOF

            sudo ln -sf /etc/nginx/sites-available/violence-detection-staging /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx

            echo ""
            echo "=========================================="
            echo "STEP 5: Health Checks"
            echo "=========================================="

            # Wait for services to start
            sleep 5

            # Check PM2 processes
            echo "üìä PM2 Process Status:"
            pm2 list | grep staging

            # Check Docker containers
            echo ""
            echo "üê≥ Docker Container Status:"
            docker ps | grep staging

            # Test endpoints
            echo ""
            echo "üîç Testing Endpoints:"

            # Test frontend
            if curl -f http://localhost:3001 > /dev/null 2>&1; then
              echo "‚úì Frontend (Next.js) - port 3001: OK"
            else
              echo "‚úó Frontend (Next.js) - port 3001: FAILED"
            fi

            # Test backend
            if curl -f http://localhost:3002/health > /dev/null 2>&1; then
              echo "‚úì Backend (NestJS) - port 3002: OK"
            else
              echo "‚úó Backend (NestJS) - port 3002: FAILED"
            fi

            # Test ML service
            if curl -f http://localhost:8003/health > /dev/null 2>&1; then
              echo "‚úì ML Service (Python) - port 8003: OK"
            else
              echo "‚úó ML Service (Python) - port 8003: FAILED"
            fi

            echo ""
            echo "=========================================="
            echo "‚úì Staging Deployment Complete!"
            echo "=========================================="
            echo "üåê Staging URL: http://stagingvision.nexaratech.io"
            echo ""
            echo "Services:"
            echo "  ‚Ä¢ Frontend (Next.js): port 3001"
            echo "  ‚Ä¢ Backend (NestJS): port 3002"
            echo "  ‚Ä¢ ML Service (Python): port 8003"
            echo ""
            echo "PM2 Processes:"
            echo "  ‚Ä¢ nexara-vision-frontend-staging"
            echo "  ‚Ä¢ nexara-vision-backend-staging"
            echo ""
            echo "Docker Containers:"
            echo "  ‚Ä¢ nexara-ml-service-staging"
            echo "=========================================="

            # Save PM2 process list
            pm2 save
          ENDSSH

      - name: Notify Success
        if: success()
        run: |
          echo "‚úì Successfully deployed NEW stack to staging!"
          echo "Staging URL: http://stagingvision.nexaratech.io"
          echo ""
          echo "Stack deployed:"
          echo "  ‚Ä¢ Next.js Frontend"
          echo "  ‚Ä¢ NestJS Backend"
          echo "  ‚Ä¢ Python ML Service"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚úó Staging deployment failed"
          echo "Check the logs above for details"
          exit 1
